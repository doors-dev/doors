package test

import (
	"context"
	"fmt"
	"net/http"

	"github.com/doors-dev/doors"
	"github.com/doors-dev/gox"
)

elem Report(value string) {
	~(ReportId(0, value))
}

elem ReportId(id int, value string) {
	<div id=(fmt.Sprintf("report-%d", id))>~(value)</div>
}

elem Marker(id string) {
	<div id=(id)></div>
}

type page[P any]interface {
	h1() string
	content(doors.Source[P]) gox.Elem
	head(doors.Source[P]) gox.Elem
}

elem Document[P any](p page[P], b doors.Source[P]) {
	<!DOCTYPE html>
	<html lang="en">
		<head>
			<meta charset="UTF-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			~>doors.ARawFileHref{
				Handler: func(w http.ResponseWriter, r *http.Request) {},
			}
			<link
				rel="icon"
				type="image/png"/>
	~//		~(p.head(b))
		</head>
		<body>
			<h1>~(p.h1())</h1>
			~(p.content(b))
		</body>
	</html>
}

func NewReporter(size int) *Reporter {
	reports := make([]*doors.Door, size)
	for i := range size {
		reports[i] = &doors.Door{}
	}
	return &Reporter{
		reports: reports,
	}
}

type Reporter struct {
	reports []*doors.Door
}

func (r *Reporter) Update(ctx context.Context, i int, content string) {
	r.reports[i].Update(ctx, ReportId(i, content))
}

elem (r *Reporter) Main() {
	~(for _, report := range r.reports {
		~(report)
	})
}

elem Button(id string, handler func(context.Context) bool) {
	~>doors.AClick{
		On: func(ctx context.Context, _ doors.REvent[doors.PointerEvent]) bool {
			return handler(ctx)
		},
	}
	<button id=(id)>~(id)</button>
}
